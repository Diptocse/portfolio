var Shira;!function(t,o){var n;(n=t.ScrollWatch||(t.ScrollWatch={})).Watcher=function(t,e,s){if(t.length<1)throw new Error("No sections given");if(this.sections=t,this.callback=e,this.options=o.extend({},n.Watcher.defaults,s),this.options.scroller)this.scroller=this.options.scroller;else if(this.scroller=this.guessScroller(t[0]),!this.scroller)throw new Error('Could not determine scroller of the given sections, please provide the "scroller" option');this.lastFocus=null,this.debugFocusLine=null,this.debugFocusLineTimeout=null,o(this.scroller).data("shira.scrollwatch",this)},n.Watcher.defaults={scroller:null,throttle:!0,resolutionMode:"height",resolver:null,topDownWeight:0,viewMarginTop:0,viewMarginBottom:0,stickyOffsetTop:5,stickyOffsetBottom:5,focusRatio:.38196601125010515,focusOffset:0,debugFocusLine:!1},n.Watcher.prototype={scroller:null,sections:null,callback:null,options:null,paused:!1,attached:!1,getElementY:function(t,e){window!==e&&void 0!==e||(e=null);for(var s=0;s+=t.offsetTop,(t=t.offsetParent)&&t!==e;);return s},guessScroller:function(t){for(var e=!1;!e;)if((t=t.offsetParent)&&1===t.nodeType&&"BODY"!==t.tagName&&"HTML"!==t.tagName){var s=o(t).css("overflow-y");e="auto"===s||"scroll"===s}else t=window,e=!0;if(e)return t},getIntersection:function(t,e,s,i){return e<s||i<t?null:[s<t?t:s,i<e?i:e]},updateSectionBoundaries:function(){this.sectionBoundaries=[];for(var t=0;t<this.sections.length;++t){var e=this.getElementY(this.sections[t],this.scroller),s=e+this.sections[t].offsetHeight;this.sectionBoundaries.push([e,s])}this.sectionBoundaries.sort(this.sortSectionBoundaries)},sortSectionBoundaries:function(t,e){return t[0]-e[0]},updateScrollerHeight:function(){window===this.scroller?(this.scrollerVisibleHeight=o(window).height(),this.scrollerFullHeight=document.body.scrollHeight):(this.scrollerVisibleHeight=this.scroller.clientHeight,this.scrollerFullHeight=this.scroller.scrollHeight)},getView:function(){var t=o(this.scroller).scrollTop(),e=t+this.scrollerVisibleHeight;return 0!==this.options.viewMarginTop&&(t+=this.options.viewMarginTop),0!==this.options.viewMarginBottom&&(e=Math.max(t+1,e-this.options.viewMarginBottom)),{top:t,bottom:e}},determineFocusCandidates:function(t){var e=[],s=null;if(this.scrollerFullHeight-t.bottom<this.options.stickyOffsetBottom?s=this.sectionBoundaries.length-1:t.top-this.options.viewMarginTop<this.options.stickyOffsetTop&&(s=0),null!==s)e.push({index:s,intersection:this.getIntersection(t.top,t.bottom,this.sectionBoundaries[s][0],this.sectionBoundaries[s][1]),section:this.sections[s]});else{for(var i=0;i<this.sectionBoundaries.length;++i){var o=this.getIntersection(t.top,t.bottom,this.sectionBoundaries[i][0],this.sectionBoundaries[i][1]);null!==o&&e.push({index:i,intersection:o,section:this.sections[i]})}if(0===e.length){var n,r=null;for(i=0;i<this.sectionBoundaries.length;++i)n=Math.abs(this.sectionBoundaries[i][0]-t.top),(null===r||r[1]>n)&&(r=i);e.push({index:r,intersection:null,section:this.sections[r]})}}return e},resolveFocusCandidates:function(t,e){var s=this,i=null;if(1===t.length)i=t[0];else switch(this.options.resolutionMode){case"height":t.sort(function(t,e){return t.index<e.index?e.intersection[1]-e.intersection[0]-(t.intersection[1]-t.intersection[0])-s.options.topDownWeight:e.intersection[1]-e.intersection[0]-(t.intersection[1]-t.intersection[0])}),i=t[0];break;case"focus-line":var o,n=e.top+(e.bottom-e.top)*this.options.focusRatio+this.options.focusOffset;for(this.options.debugFocusLine&&this.updateDebugFocusLine(Math.round(n)),o=0;o<t.length;++o)if(t[o].intersection[0]<=n&&t[o].intersection[1]>=n){i=t[o];break}if(null===i){for(o=0;o<t.length;++o)t[o].focusRatioOffsetDistance=Math.min(Math.abs(t[o].intersection[0]-n),Math.abs(t[o].intersection[1]-n));t.sort(this.sortFocusCandidatesByDistanceToFocusRatioOffset),i=t[0]}break;case"custom":if(null===this.options.resolver)throw new Error("No resolver has been set");if((i=this.options.resolver(t,e,this))instanceof Array)throw new Error("The resolver must return a single focus object");break;default:throw new Error("Invalid resolution mode")}return i},updateDebugFocusLine:function(t){var e=this;null===this.debugFocusLine&&(this.debugFocusLine=o('<div class="scrollwatch-debug-focus-line" style="position:absolute;left:0;top:0;width:100%;border-bottom:1px solid white;outline:1px solid black;z-index:10000;box-shadow: 0 0 5px black;"></div>').appendTo(window===this.scroller?document.body:this.scroller)),this.debugFocusLine.css("top",t+"px"),null!==this.debugFocusLineTimeout&&clearTimeout(this.debugFocusLineTimeout),this.debugFocusLineTimeout=setTimeout(function(){e.debugFocusLine.remove(),e.debugFocusLine=null},1e3)},sortFocusCandidatesByDistanceToFocusRatioOffset:function(t,e){return t.focusRatioOffsetDistance-e.focusRatioOffsetDistance},attach:function(){if(!this.attached){var t=this;this.updateEventHandler=function(){t.pulse()},o(this.scroller).scroll(this.updateEventHandler),window===this.scroller&&o(this.scroller).resize(this.updateEventHandler),this.attached=!0,this.pulse()}},detach:function(){this.attached&&(o(this.scroller).unbind("scroll",this.updateEventHandler),window===this.scroller&&o(this.scroller).unbind("resize"),this.attached=!1)},pulse:function(){if(!this.paused&&this.attached){this.updateSectionBoundaries(),this.updateScrollerHeight();var t=this.getView(),e=this.determineFocusCandidates(t);if("none"!==this.options.resolutionMode){var s=this.resolveFocusCandidates(e,t);this.options.throttle&&this.lastFocus&&s.index===this.lastFocus.index||(this.callback(s,t,this),this.lastFocus=s)}else this.callback(e,t,this)}}},n.ActiveClassMapper=function(t,e){e=e||"active",this.items=t,this.activeClass=e,this.currentActiveIndexes=[]},n.ActiveClassMapper.prototype={handleFocusChange:function(t){var e,s=o(this.currentActiveIndexes).not(t).get(),i=o(t).not(this.currentActiveIndexes).get();for(e=0;e<s.length;++e)o(this.items[s[e]]).removeClass(this.activeClass);for(e=0;e<i.length;++e)o(this.items[i[e]]).addClass(this.activeClass);this.currentActiveIndexes=t},getWatcherCallback:function(){var i=this;return function(t){var e=[];if(t instanceof Array)for(var s=0;s<t.length;++s)e.push(t[s].index);else e.push(t.index);i.handleFocusChange(e)}}},o.fn.scrollWatch=function(t,e){return 0<this.length&&new n.Watcher(this.toArray(),t,e).attach(),this},o.fn.scrollWatchMapTo=function(t,e,s){if(0<this.length){if("string"==typeof t)t=o(t).toArray();else if(t instanceof o)t=t.toArray();else if(!(t instanceof Array))throw new Error("Invalid items - expected a selector, array or a jQuery object");var i=new n.ActiveClassMapper(t,e).getWatcherCallback();new n.Watcher(this.toArray(),i,s).attach()}return this}}(Shira=Shira||{},jQuery);